---
title: "Interpreting Machine Learning Models - Variable Importance"
author: "Craig A. Sloss"
date: "2023-05-14"
output: html_document
---

# Introduction and Setup

Settings for this notebook:

* Code will be printed along with the outcome of running that code

* Turn off scientific notation

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 999)
```

Load packages used in this notebook. Please ensure that you have run the script 0a_install_packages.R prior to running this code chunk.

```{r}
library(tidyverse)
library(DALEX)
library(xgboost)
```

Load the dataset that was prepared in the notebook 0b_data_preparation.Rmd, and preview it:
```{r}
severity_modelling_data = readRDS("../data/severity_modelling_data.rds")
severity_modelling_data %>% head()
```

# Fit Sample Models

Create a list of all predictors available in the data:
```{r}
full_predictor_set = c("DrivAge",
                       "DrivGender",
                       "MaritalStatus",
                       "BonusMalus",
                       "LicenceNb",
                       "PayFreq",
                       "JobCode",
                       "VehAge",
                       "VehClass",
                       "VehPower",
                       "VehGas",
                       "VehUsage",
                       "Garage",
                       "Area",
                       "Marketing")
```

This is a convenience function that will fit a Gradient Boosted Machine, using the xgboost package, given a list of predictors. The model is fit using the severity modelling dataset loaded above. Because the purpose of this work is to create sample models that can be used to illustrate the use of the DALEX package, these models are not tuned or validated on holdout data. (Note that by not tuning the hyperparameters, this ensures they are the same for all models being compared.)

```{r}
fit_gbm = function(variable_list) {
  formula = paste0("Payment ~ ", paste0(variable_list, collapse = " + ")) %>% as.formula
  xgb_response = severity_modelling_data$Payment
  xgb_matrix = model.matrix(formula, severity_modelling_data)
  set.seed(12345)
  sample_model = xgboost(data = xgb_matrix,
                         label = xgb_response,
                         max_depth = 2,
                         eta = 0.01,
                         nrounds = 60)
  return(sample_model)
}
```

```{r}
sample_model_full = fit_gbm(full_predictor_set)
```

Create comparison models that remove driver age and vehicle age from the list of predictors:

```{r}
sample_model_no_driver_age = fit_gbm(setdiff(full_predictor_set, "DrivAge"))
```

```{r}
sample_model_no_veh_age = fit_gbm(setdiff(full_predictor_set, "VehAge"))
```
